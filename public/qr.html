<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<style type="text/css">
		@media print
		{    
		    img {
				page-break-inside: avoid;
			}
		}
	</style>

</head>

<body>
<!-- with input that accepts one file -->
<div class="container hidden-print">
	<div class="container">
		<div class="input-group input-group-lg">
			<input id="the-file-input" class="form-control" type="file">
			<textarea id="the-file-content" class="form-control hidden" placeholder="File content"></textarea>
		</div>
	</div>
</div>

<div id="qrs" class="container">

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="qrcode-min.js"></script>

<script type="text/javascript">
$("#the-file-input").change(function() {
	// will log a FileList object, view gifs below
	console.log(this.files); /*files*/
	var reader = new FileReader();
	reader.onload = function(event) {
		console.log(event);
		var content = event.target.result;

		if (content.startsWith('data')) { /* indicate use of readAsDataURL */
			content = content.replace(/^data(.*)base64,/,"");
		}

		$("#the-file-content").val(content);
		loadQR(content);
	};

	if ((this.files != undefined) && (this.files[0] != undefined)) {
		reader.readAsDataURL(this.files[0]); // readAsDataURL base64-encode the file
	}
});

function initProgress(total) {
	var increment = 100 / total;
	var current = 0;
	return {
		increase : function () {
			current += increment;
			console.log('Progress: ' + Math.round(current) + ' %');
		}
	}
}

function chunk (arr, len) {

	var chunks = [],
		i = 0,
		n = arr.length;

	while (i < n) {
		chunks.push(arr.slice(i, i += len));
	}

	return chunks;
}

function loadQR(what) {


	var chunks = chunk(what, 2560); //length of qrcode text = 2560
	var groups = chunk(chunks, 2); // number of layout columns = 2

	console.log('Chunks: ', chunks.length);

	$("#qrs").empty();

	start = Date.now();

	var progress = initProgress(chunks.length);

	groups.map( function ( row ) {
		function makeImgPromise(img) {
			return new Promise(function(resolve, reject){
				
				var qr = qrcode(40, 'L');
				qr.addData(img);
				qr.make();
				progress.increase();

				resolve('<div class="col-xs-6 col-md-6">' + qr.createImgTag() + '</div>');
			});
		};
		Promise.all(row.map(makeImgPromise))
		.then(function(done){
			$("#qrs").append('<div class="row">' + done.join('\n') + '</div>');	
		})
	});


	console.log('Total time: ', Date.now() - start);
} //loadQR

</script>

</body>
</html>